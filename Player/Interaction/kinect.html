<!DOCTYPE html>
<html>
  <head>
    <style>
      .kinect { 
        background: #000;
        width: 320px;
        height: 240px;
        display: none;
        /*visibility: hidden;*/
      }   
    </style>
  </head>

  <body>
    <div id="status"></div>
    <canvas id="kcolor" class="kinect"></canvas>
    <canvas id="kdepth" class="kinect"></canvas>
    <div id="kgl">
    </div>
  </body>

  <script src="extra/three.min.js"></script>
  <script src="extra/leap.min.js"></script>
  <script src="extra/jq.mobi.min.js"></script>
  <script src="http://mrdoob.github.com/three.js/examples/js/controls/TrackballControls.js"></script>
  <script src="http://mrdoob.github.com/three.js/examples/js/Detector.js"></script>
  
  <script src="gl_kinect_mesh.js"></script>
  <!--
  <script src="gl_kinect_particles.js"></script>
-->
  <script>
    var host = window.document.location.host.replace(/:.*/, '');
    if( host.length==0 ){
      host = "localhost";
    }
    console.log("Connecting to "+host);
  </script>

  <!--Receiving an image-->
  <script>
    console.log('Connecting to '+host+' 9002')
    var ws_i = new WebSocket('ws://' + host + ':9002');
    ws_i.binaryType = "blob";
    var jpeg_url_name = "";
    var myimg = new Image;

    // Create a canvas element
    var cCanvas = $('#kcolor')[0];
    cCanvas.width = 320;
    cCanvas.height = 240;
    var c_ctx = cCanvas.getContext('2d');

    // Create a canvas element
    var dCanvas = $('#kdepth')[0];
    dCanvas.width = 320;
    dCanvas.height = 240;
    var d_ctx = dCanvas.getContext('2d');
    myctx = d_ctx;
    ws_i.onmessage = function (event) {
      if( event.data.size>20000 ){
        //console.log(event.data.size);
        myctx = c_ctx;
      } else {
        myctx = d_ctx;
      }
      // Revoke the previous
      if( jpeg_url_name !== undefined ) {
        window.URL.revokeObjectURL(jpeg_url_name);
      }
      event.data.type = "image\/jpeg";
      var jpeg_url_name = window.URL.createObjectURL( event.data );
      myimg.src = jpeg_url_name;
      myimg.onload = function(){
        myctx.drawImage( myimg, 0, 0 );
        var imgdata = myctx.getImageData(0, 0, 320, 240);
        if( event.data.size>20000 ){ // color
          update_kinect_image( new Uint8Array(imgdata.data.buffer ) );
        } else {
          update_kinect_depth( new Uint8Array(imgdata.data.buffer ) );
        }
      };
    };
  </script>

</html>
